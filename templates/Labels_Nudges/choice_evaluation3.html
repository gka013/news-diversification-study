{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>News Feed – Phase 3</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">

  <!-- Bootstrap CSS & Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet"
  />

  <!-- Google Font Inter -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    /* … copy all your existing CSS from choice_evaluation.html here … */
  </style>
</head>
<body>

  <div class="container-custom">

    <!-- Instructions (same as before) -->
    <section class="study-instructions">
      <h3>Welcome to Phase 3 of the News Interface</h3>
      <p class="lead">Save at least one article then click “Next” to finish.</p>
      <!-- your instr-grid … -->
    </section>

    <!-- Hero (optional) -->
    {% if articles %}
      {% with hero=articles.0 %}
      <section class="hero">
        <div class="hero-content">
          <h1>{{ hero.title }}</h1>
          <p>{{ hero.body|truncatewords:30 }}</p>
        </div>
      </section>
      {% endwith %}
    {% endif %}

    <!-- Tabs & header -->
    <div class="section-header">
      <h2>News Feed – Phase 3</h2>
      <div class="toggle-pill btn-group" role="group">
        <button id="btnLatest"   class="btn btn-light active">Latest</button>
        <button id="btnSavedNews" class="btn btn-light">Saved News</button>
      </div>
    </div>

    <!-- Error if none saved -->
    <div id="errorBox" class="alert alert-danger error-box d-none" role="alert">
      Please save at least one article before continuing.
    </div>

    <div class="row-feed">
      <!-- Latest feed grid -->
      <div class="feed-main" id="feedLatest">
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
          {% for art in articles %}
            {% if art.media %}
            <div class="col">
              <div class="news-card" id="card-{{ forloop.counter }}">
                <img src="{{ art.media }}" alt="{{ art.title }}">
                <div class="news-body">
                  <div class="news-title">{{ art.title }}</div>
                  <div class="news-desc">{{ art.body|truncatewords:20 }}</div>
                </div>
                <div id="fullText-{{ forloop.counter }}"
                     class="news-text" style="display:none;">
                  {{ art.body }}
                </div>
                <div class="news-footer">
                  <span id="toggle-{{ forloop.counter }}"
                        class="toggle-link"
                        onclick="toggleText({{ forloop.counter }})">
                    More <span id="arrow-{{ forloop.counter }}">▼</span>
                  </span>
                  <button class="bookmark-btn"
                          id="icon-{{ forloop.counter }}"
                          onclick="toggleSave({{ forloop.counter }})"
                          title="Save this article">
                    <i class="bi bi-bookmark"></i>
                  </button>
                </div>
              </div>
            </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <!-- Saved feed -->
      <div class="feed-main d-none" id="feedSavedNews">
        <h3>Saved Articles</h3>
        <div id="savedArticlesContent"
             class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        </div>
      </div>

      <!-- Trending sidebar (same) -->
      <aside class="feed-aside">
        <div class="trending">
          <div class="header"><h4>Trending Now</h4></div>
          {% for art in articles|slice:":5" %}
            {% if art.media %}
            <div class="trending-item">
              <div class="num">{{ forloop.counter|stringformat:"02d" }}</div>
              <div class="info">
                <a href="#">{{ art.title|truncatechars:40 }}</a>
                <p>{{ art.body|truncatewords:10 }}</p>
              </div>
            </div>
            {% endif %}
          {% endfor %}
        </div>
      </aside>
    </div>

    <!-- Next button & progress -->
    <div class="next-wrapper">
      <button id="btnNext"
              class="next-btn"
              disabled
              aria-disabled="true"
              onclick="submitSaved()">
        Next &nbsp;<i class="bi bi-arrow-right"></i>
      </button>
    </div>
    <div class="progress" style="height:20px; margin-top:1rem;">
      <div class="progress-bar" role="progressbar"
           style="width:75%" aria-valuenow="75"
           aria-valuemin="0" aria-valuemax="100">
        Phase 3 (75%)
      </div>
    </div>

  </div>

  <!-- JS (just swap the POST target to choice_evaluation3) -->
  <script>
    let savedList = [];

    function updateNext() {
      const btn = document.getElementById('btnNext');
      btn.disabled = !savedList.length;
      btn.classList.toggle('enabled', savedList.length > 0);
    }

    function toggleSave(id) {
      const idx       = savedList.indexOf(id),
            icon      = document.querySelector(`#icon-${id} .bi`),
            container = document.getElementById('savedArticlesContent'),
            err       = document.getElementById('errorBox');

      if (idx > -1) {
        savedList.splice(idx,1);
        icon.classList.replace('bi-bookmark-fill','bi-bookmark');
        container.querySelector(`[data-article-id="${id}"]`)?.remove();
      } else {
        savedList.push(id);
        icon.classList.replace('bi-bookmark','bi-bookmark-fill');
        err.classList.add('d-none');
        const clone = document.getElementById(`card-${id}`).cloneNode(true);
        clone.dataset.articleId = id;
        clone.querySelector(`#icon-${id} .bi`)
             .className = 'bi bi-bookmark-fill';
        clone.querySelector(`#icon-${id}`)
             .onclick   = () => toggleSave(id);
        container.appendChild(clone);
      }
      updateNext();
    }

    function submitSaved() {
      const err = document.getElementById('errorBox');
      if (!savedList.length) {
        err.classList.remove('d-none');
        return;
      }
      const f = document.createElement('form');
      f.method = 'POST';
      f.action = "{% url 'Labels_Nudges:choice_evaluation3' %}";
      const csrf = document.createElement('input');
      csrf.type  = 'hidden';
      csrf.name  = 'csrfmiddlewaretoken';
      csrf.value = '{{ csrf_token }}';
      f.appendChild(csrf);

      const hid = document.createElement('input');
      hid.type  = 'hidden';
      hid.name  = 'saved_articles';
      hid.value = JSON.stringify(savedList);
      f.appendChild(hid);

      document.body.appendChild(f);
      f.submit();
    }

    // Tab switching
    document.getElementById('btnLatest').onclick = () => {
      document.getElementById('feedLatest').classList.remove('d-none');
      document.getElementById('feedSavedNews').classList.add('d-none');
      btnLatest .classList.add('active');
      btnSavedNews.classList.remove('active');
    };
    document.getElementById('btnSavedNews').onclick = () => {
      document.getElementById('feedSavedNews').classList.remove('d-none');
      document.getElementById('feedLatest')   .classList.add('d-none');
      btnSavedNews.classList.add('active');
      btnLatest   .classList.remove('active');
    };

    // Expand/collapse
    function toggleText(id) {
      const textEl  = document.getElementById(`fullText-${id}`),
            linkEl  = document.getElementById(`toggle-${id}`),
            arrowEl = document.getElementById(`arrow-${id}`),
            isOpen  = textEl.style.display === 'block';

      textEl.style.display = isOpen ? 'none' : 'block';
      linkEl.innerHTML     = (isOpen ? 'More ' : 'Less ') +
                             `<span id="arrow-${id}">${isOpen?'▼':'▲'}</span>`;
    }

    document.addEventListener('DOMContentLoaded', updateNext);
  </script>
</body>
</html>
